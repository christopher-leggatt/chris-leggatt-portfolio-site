name: Deploy to EC2

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v2

    - name: Deploy to EC2
      env:
        DEPLOY_SSH_KEY: ${{ secrets.DEPLOY_SSH_KEY }}
        EC2_HOST: ${{ secrets.EC2_HOST }}
      run: |
        SSH_KEY_FILE=$(mktemp /tmp/ssh_key.XXXXXX)
        echo "$DEPLOY_SSH_KEY" > "$SSH_KEY_FILE"
        chmod 600 "$SSH_KEY_FILE"
        ssh -o "StrictHostKeyChecking=no" -i "$SSH_KEY_FILE" ubuntu@"$EC2_HOST" << 'ENDSSH'
        cd ~/repos/chris-leggatt-portfolio-site/
        git pull origin main
        npm install
        npm run build
        pm2 restart all
        ENDSSH
        rm -f "$SSH_KEY_FILE"
